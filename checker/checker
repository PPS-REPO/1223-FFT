#include "testlib.h"
#include <cmath>
#include <string>
#include <vector>
#include <algorithm>

using namespace std;

const double MAX_ERROR = 1e-4;

bool areEqual(double expected, double found) {
    if (std::isnan(expected) || std::isnan(found)) return false;
    if (std::isinf(expected) || std::isinf(found)) return false;

    double diff = std::abs(expected - found);

    if (diff <= MAX_ERROR) return true;

    double absExpected = std::abs(expected);
    if (absExpected > 1e-9) {
        if (diff / absExpected <= MAX_ERROR) return true;
    }

    return false;
}

int main(int argc, char* argv[]) {
    setName("Compare FFT results (Real/Imag parts) with precision %.1e", MAX_ERROR);
    registerTestlibCmd(argc, argv);

    int n = 0;

    while (!ans.seekEof()) {
        n++;

        double jReal = ans.readDouble();
        double jImag = ans.readDouble();

        if (ouf.seekEof()) {
            quitf(_wa, "Output is shorter than expected. Missing complex number at index %d", n);
        }

        double pReal = ouf.readDouble();
        double pImag = ouf.readDouble();

        if (!areEqual(jReal, pReal)) {
            quitf(_wa, "Real part mismatch at index %d: expected %.5f, found %.5f", n, jReal, pReal);
        }

        if (!areEqual(jImag, pImag)) {
            quitf(_wa, "Imag part mismatch at index %d: expected %.5f, found %.5f", n, jImag, pImag);
        }
    }

    if (!ouf.seekEof()) {
        quitf(_wa, "Participant output has extra tokens after the last expected number.");
    }

    quitf(_ok, "Accepted: %d complex numbers verified.", n);

    return 0;
}